<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>你活不嚇去 — 強化版</title>
  <style>
    body { margin:0; overflow:hidden; background:black; }
    canvas { display:block; margin:0 auto; background:black; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let player = { x:100, y:300, w:30, h:50, dy:0, jump:false, bullets:30, facing:1, meat:0 };
let gravity = 0.8;
let cameraX = 0;
let gameOver = false;
let score = 0;
let startTime = Date.now();

let torchTime = 10000;
let lastTorchPickup = Date.now();
let torches = [{x:300, y:300, w:12, h:28}];

let grounds = [{x:0, y:350, w:2000, h:50}];
let platforms = [];
for(let i=0;i<15;i++){
  let movingType = Math.random()<0.5 ? 'horizontal' : 'vertical';
  let range = 40 + Math.random()*40;
  let baseX = 200*i+150;
  let baseY = 250 - Math.random()*120;
  platforms.push({ x:baseX, y:baseY, w:100, h:10, baseX, baseY, movingType, range, dir:1 });
}

let keys = {};
document.addEventListener("keydown", e=>keys[e.key]=true);
document.addEventListener("keyup", e=>keys[e.key]=false);

let monsters = [];
let bullets = [];
let boxes = [];
let animals = [];
let lastMonsterTime = 0;

// 火焰粒子系統
let particles = [];
function emitFlame(x,y){
  for(let i=0;i<4;i++){
    particles.push({
      x: x + (Math.random()-0.5)*6,
      y: y + (Math.random()-0.5)*6,
      vx: (Math.random()-0.5)*0.6,
      vy: - (0.5 + Math.random()*1.2),
      life: 600 + Math.random()*400,
      born: Date.now(),
      size: 2 + Math.random()*3
    });
  }
}

function spawnMonster(){
  let spawnX = player.x + (Math.random()<0.5 ? -400 : 400);
  let spawnY = player.y - 150 - Math.random()*100;
  monsters.push({x:spawnX, y:spawnY, w:40, h:50, dy:0, hp:5});
}

function spawnAnimal(){
  let spawnX = player.x + 200 + Math.random()*400;
  let spawnY = player.y - 50;
  animals.push({x:spawnX, y:spawnY, w:20, h:20, dy:0, hp:1});
}

function shoot(){
  if(player.bullets>0){
    let speed = 8 * player.facing;
    bullets.push({x:player.x+player.w/2, y:player.y+player.h/2, w:10, h:4, speed:speed});
    player.bullets--;
  }
}

document.addEventListener('keydown', e=>{ 
  if(e.key==='r'||e.key==='R'){ setTimeout(()=>player.bullets=30,1000); }
});
document.addEventListener('keydown', e=>{ if(e.code==='Space') shoot(); });

function update(){
  if(gameOver) return;

  // 玩家移動
  if(keys['a']||keys['ArrowLeft']){ player.x-=3; player.facing=-1; }
  if(keys['d']||keys['ArrowRight']){ player.x+=3; player.facing=1; }
  if((keys['w']||keys['ArrowUp']) && !player.jump){ player.dy=-12; player.jump=true; }

  player.dy += gravity; player.y += player.dy;

  // 平台移動
  platforms.forEach(p=>{
    if(p.movingType==='horizontal') p.x += p.dir*1.2;
    else p.y += p.dir*1.2;
    if(p.movingType==='horizontal' && Math.abs(p.x-p.baseX)>p.range) p.dir*=-1;
    if(p.movingType==='vertical' && Math.abs(p.y-p.baseY)>p.range) p.dir*=-1;
  });

  // 玩家碰撞
  let onGround=false;
  grounds.concat(platforms).forEach(g=>{
    if(player.y+player.h>=g.y && player.y+player.h<=g.y+g.h && player.x+player.w>g.x && player.x<g.x+g.w){
      player.y=g.y-player.h; player.dy=0; player.jump=false; onGround=true;
    }
  });

  if(player.y>canvas.height) gameOver=true;

  cameraX = player.x - 200;

  if(Date.now() - lastMonsterTime > 1000){ 
    spawnMonster(); 
    if(Math.random()<0.3) spawnAnimal();
    lastMonsterTime = Date.now(); 
  }

  // 敵人靠近
  monsters.forEach((m,mi)=>{
    let dx = player.x - m.x;
    if(Math.abs(dx) > 1) m.x += Math.sign(dx) * 0.6;
    m.dy += gravity; m.y += m.dy;
    grounds.concat(platforms).forEach(g=>{
      if(m.y+m.h>=g.y && m.y+m.h<=g.y+g.h && m.x+m.w>g.x && m.x<g.x+g.w){ m.y=g.y-m.h; m.dy=0; }
    });
    if(player.x<m.x+m.w && player.x+player.w>m.x && player.y<m.y+m.h && player.y+player.h>m.y){
      if(player.meat>0){ player.meat--; monsters.splice(mi,1); }
      else gameOver=true;
    }
  });

  // 小動物靠近
  animals.forEach((a,ai)=>{
    let dx = player.x - a.x;
    if(Math.abs(dx) > 1) a.x += Math.sign(dx) * 0.5;
    a.dy += gravity; a.y += a.dy;
    grounds.concat(platforms).forEach(g=>{
      if(a.y+a.h>=g.y && a.y+a.h<=g.y+g.h && a.x+a.w>g.x && a.x<g.x+g.w){ a.y=g.y-a.h; a.dy=0; }
    });
    // 撞玩家可吃掉（可做掉落）
  });

  // 子彈更新
  bullets.forEach((b,bi)=>{
    b.x += b.speed;
    // 打怪
    for(let mi=monsters.length-1; mi>=0; mi--){
      const m = monsters[mi];
      if(b.x < m.x + m.w && b.x + b.w > m.x && b.y < m.y + m.h && b.y + b.h > m.y){
        m.hp--; m.x += (player.facing*2);
        bullets.splice(bi,1);
        if(m.hp <= 0){
          if(Math.random()<0.5) boxes.push({x:m.x, y:m.y-20, w:20, h:20});
          if(Math.random()<0.5 && player.meat<5) player.meat++; // 增加肉
          monsters.splice(mi,1);
        }
        break;
      }
    }
    // 打小動物
    for(let ai=animals.length-1; ai>=0; ai--){
      const a = animals[ai];
      if(b.x < a.x + a.w && b.x + b.w > a.x && b.y < a.y + a.h && b.y + b.h > a.y){
        bullets.splice(bi,1);
        if(player.meat<5) player.meat++; // 打死掉小動物獲得肉
        animals.splice(ai,1);
        break;
      }
    }
  });

  // 拾取寶箱補子彈
  boxes.forEach((box,bi)=>{
    if(player.x<box.x+box.w && player.x+player.w>box.x && player.y<box.y+box.h && player.y+player.h>box.y){
      player.bullets=30; boxes.splice(bi,1);
    }
  });

  // 火把撿取
  torches.forEach((t,ti)=>{
    emitFlame(t.x - cameraX + t.w/2, t.y + 6);
    if(player.x < t.x + t.w && player.x + player.w > t.x && player.y < t.y + t.h && player.y + player.h > t.y){
      lastTorchPickup = Date.now();
      torches.splice(ti,1);
      torches.push({x:player.x + 500 + Math.random()*500, y:300 - Math.random()*100, w:12, h:28});
    }
  });

  const now = Date.now();
  for(let i=particles.length-1;i>=0;i--){
    particles[i].x += particles[i].vx;
    particles[i].y += particles[i].vy;
    particles[i].vy += 0.02;
    if(now - particles[i].born > particles[i].life) particles.splice(i,1);
  }

  if(Date.now() - lastTorchPickup > torchTime) gameOver=true;

  score = Math.floor((Date.now()-startTime)/1000);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // 光圈
  let elapsed = Date.now() - lastTorchPickup;
  let lightRadius = Math.max(80, 160 - (elapsed/torchTime)*120);
  let lx = player.x - cameraX + player.w/2;
  let ly = player.y + player.h/2;
  let grad = ctx.createRadialGradient(lx, ly, 0, lx, ly, lightRadius);
  grad.addColorStop(0, 'rgba(255,255,220,0.98)');
  grad.addColorStop(0.4, 'rgba(200,150,100,0.6)');
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);

  // 地板平台
  grounds.forEach(g=>{ ctx.fillStyle='yellow'; ctx.fillRect(g.x-cameraX, g.y, g.w, g.h); });
  platforms.forEach(p=>{ ctx.fillStyle='yellow'; ctx.fillRect(p.x-cameraX, p.y, p.w, p.h); });

  // 火焰粒子
  particles.forEach(pt=>{
    const lifeRatio = 1 - (Date.now() - pt.born)/pt.life;
    ctx.globalAlpha = Math.max(0, lifeRatio);
    ctx.fillStyle = 'rgba(255,160,40,1)';
    ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
  });

  // 怪物紅色方塊 + 綠色冒煙眼
  monsters.forEach(m=>{
    ctx.fillStyle='red'; ctx.fillRect(m.x-cameraX, m.y, m.w, m.h);
    // 冒煙眼睛
    ctx.fillStyle='lime';
    ctx.fillRect(m.x+10-cameraX, m.y+10, 5,5);
    ctx.fillRect(m.x+25-cameraX, m.y+10, 5,5);
  });

  // 小動物
  animals.forEach(a=>{ ctx.fillStyle='pink'; ctx.fillRect(a.x-cameraX, a.y, a.w, a.h); });

  // 子彈
  bullets.forEach(b=>{ ctx.fillStyle='white'; ctx.fillRect(b.x-cameraX, b.y, b.w, b.h); });
  boxes.forEach(box=>{ ctx.fillStyle='purple'; ctx.fillRect(box.x-cameraX, box.y, box.w, box.h); });
  torches.forEach(t=>{ ctx.fillStyle='orange'; ctx.fillRect(t.x-cameraX, t.y, t.w, t.h); });

  // 玩家
  ctx.fillStyle='white'; ctx.fillRect(player.x-cameraX, player.y, player.w, player.h);

  // HUD
  ctx.fillStyle='white'; ctx.font='20px Arial';
  ctx.fillText('時間: '+score+' 秒',20,30);
  ctx.fillText('子彈: '+player.bullets+'/30',20,60);
  ctx.fillText('火把剩餘: '+Math.max(0,((torchTime-(Date.now()-lastTorchPickup))/1000).toFixed(1))+' 秒',20,90);
  ctx.fillText('肉: '+player.meat+'/5',20,120);

  if(gameOver){ ctx.fillStyle='red'; ctx.font='40px Arial'; ctx.fillText('遊戲結束! 按 F5 重開',150,200); }
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
